{#
 * @name      EosAlpha BBS
 * @copyright 2011 Alex Vie silvercircle(AT)gmail(DOT)com
 *
 * This software is a derived product, based on:
 *
 * Simple Machines Forum (SMF)
 * copyright: 2011 Simple Machines (http://www.simplemachines.org)
 * license:   BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0pre
 * 
 * display a topic page
 #}
{% extends "base.twig" %}
{% use "postbits.twig" %}
{% import "generics.twig" as generics %}
{% block content %}
{% set tabindex = C.tabindex %}
<div class="jqmWindow" style="display:none;" id="interpostlink_helper">
  <div class="jqmWindow_container">
    <div class="glass jsconfirm title">
      {{ T.quick_post_link_title }}
    </div>
    <div class="blue_container norounded lefttext smalltext mediumpadding mediummargin">
      {{ T.quick_post_link_text }}
      <dl class="common left" style="line-height:24px;">
        <dt><strong>{{ T.quick_post_link_bbcode }}</strong></dt><dd><input size="78" type="text" id="interpostlink_helper_content" value="" /></dd>
        <dt><strong>{{ T.quick_post_link_full }}</strong></dt><dd><input size="78" type="text" id="interpostlink_helper_content_full" value="" /></dd>
      </dl>
    </div>
    <div class="centertext smalltext smallpadding"><span class="button default centered" onclick="$('#interpostlink_helper').css('position','static');$('#interpostlink_helper').hide();setDimmed(0);">{{ T.quick_post_link_dismiss }}</span></div>
  </div>
</div>
<div id="share_bar" style="display:none;position:absolute;right:0;white-space:nowrap;width:auto;">
  <div class="bmbar">
    <span role="button" class="button icon share_this share_fb" data-href="http://www.facebook.com/sharer.php?u=%%uri%%">Share</span>
    <span role="button" class="button icon share_this share_tw" data-href="http://twitter.com/share?text=%%txt%%&amp;url=%%uri%%">Tweet</span>
    <span role="button" class="button icon share_this share_digg" data-href="http://digg.com/submit?phase=2&amp;title=%%txt%%&amp;url=%%uri%%">Digg</span>
    <div class="clear"></div>
  </div>
</div>
{% if C.report_sent is defined and C.report_sent %}
  <div class="windowbg" id="profile_success">
    {{ T.report_sent }}
  </div>
{% endif %}
{{ C.template_hooks.display.header }}
<a id="top"></a>
{{ C.first_new_message ? '<a id="new"></a>' : '' }}
{# Is this topic also a poll? #}
{% if C.is_poll %}
  <br>
  <div id="poll">
    <div class="cat_bar">
      <h3>
        <span class="ie6_header floatleft"><img src="{{ S.images_url }}/topic/{{ C.poll.is_locked ? 'normal_poll_locked' : 'normal_poll' }}.gif" alt="" class="icon" />{{ T.poll }}</span>
      </h3>
    </div>
    <div class="blue_container cleantop">
      <div class="content" id="poll_options">
        <h4 id="pollquestion">
          {{ C.poll.question }}
        </h4>';
        {# Are they not allowed to vote but allowed to view the options? #}
        {% if C.poll.show_results or C.allow_vote == 0 %}
          <dl class="options">
          {# Show each option with its corresponding percentage bar. #}
          {% for option in C.poll.options %}
            <dt class="smalltext{{ option.voted_this ? ' voted' : '' }}">{{ option.option }}</dt>
            <dd class="smalltext statsbar{{ option.voted_this ? ' voted' : '' }}">
            {% if C.allow_poll_view %}
              {{ option.bar_ndt }}
              <span class="percentage">{{ option.votes }} ({{ option.percent }}%)</span>
            {% endif %}
            </dd>
          {% endfor %}
          </dl>
          {% if C.allow_poll_view %}
            <p><strong>{{ T.poll_total_voters }}:</strong> {{ C.poll.total_votes }}</p>
          {% endif %}
        {% else %} {# show_results #}
          {# They are allowed to vote! Go to it! #}
          <form action="{{ SCRIPTURL }}?action=vote;topic={{ C.current_topic }}.{{ C.start }};poll={{ C.poll.id }}" method="post" accept-charset="UTF-8">
          {# Show a warning if they are allowed more than one option.#}
          {% if C.poll.allowed_warning %}
            <p class="smallpadding">{{ C.poll.allowed_warning }}</p>
          {% endif %}
          <ul class="reset options">
          {# Show each option with its button - a radio likely. #}
          {% for option in C.poll.options %}
            <li class="smalltext">{{ option.vote_button }} <label for="{{ option.id }}">{{ option.option }}</label></li>
          {% endfor %}
          </ul>
          <div class="submitbutton">
            <input type="submit" value="{{ T.poll_vote }}" class="button_submit" />
            <input type="hidden" name="{{ C.session_var }}" value="{{ C.session_id }}" />
          </div>
          </form>
        {% endif %} {# show_results #}
        {# Is the clock ticking? #}
        {% if C.poll.expire_time is defined and C.poll.expire_time %}
          <p><strong>{{ (C.poll.is_expired ? T.poll_expired_on : T.poll_expires_on) }}:</strong> {{ C.poll.expire_time }}</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div id="pollmoderation">';
    {{ button_strip(C.poll_buttons) }}
  </div>
{% endif %} {# is_poll #}

{# Does this topic have some events linked to it? #}
{% if C.linked_calendar_events is defined and C.linked_calendar_events is not empty %}
  <div class="orange_container">
    <h3>
      {{ T.calendar_linked_events }}
    </h3>
    <ul class="reset">
    {% for event in C.linked_calendar_events %}
      <li>
        {{ (event.can_edit ? '<a href="' ~ event.modify_href ~ '"> <img src="' ~ S.images_url ~ '/icons/modify_small.gif" alt="" title="' ~ T.modify ~ '" class="edit_event" /></a> ' : '') }} <strong>{{ event.title }}</strong>: {{ event.start_date }}{{ (event.start_date != event.end_date ? ' - ' ~ event.end_date : '') }}
      </li>
    {% endfor %}
    </ul>
  </div>
{% endif %} {# C.linked_calendar_events #}
<div id="forumposts"><form data-alt="{{ SCRIPTURL }}?action=post;msg=%id_msg%;topic={{ C.current_topic }}.{{ C.start }}" action="{{ SCRIPTURL }}?action=quickmod2;topic={{ C.current_topic }}.{{ C.start }}" method="post" accept-charset="UTF-8" name="quickModForm" id="quickModForm" style="margin: 0;" onsubmit="return oQuickModify.bInEditMode ? oQuickModify.modifySave('{{ C.session_id }}', '{{ C.session_var }}') : false">
  {# Get all the messages... #}
  {% for msg in C.message_ids %}
    {% set foo = getMessage() %}
    {% set message = C.current_message %}
    {% block postbit %}
      {{ parent() }}
    {% endblock postbit %}
    {% if message.id == C.first_message %}
      {% if C.use_share %}
        <div class="title">{{ T.share_topic }}:</div>
        <div id="socialshareprivacy"></div><div class="clear"></div>
      {% endif %}
      {% if C.tags_active %}
        <div id="tagstrip"><span id="tags">
        {% for i, tag in C.topic_tags %}
          <a href="{{ SCRIPTURL }}?action=tags;tagid={{ tag.ID_TAG }}">{{ tag.tag }}</a>
          {% if C.can_delete_tags %}
            <a href="{{ SCRIPTURL }}?action=tags;sa=deletetag;tagid={{ tag.ID }}"><span onclick="sendRequest('action=xmlhttp;sa=tags;deletetag=1;tagid={{ tag.ID }}', $('#tags'));return(false);" class="xtag">&nbsp;&nbsp;</span></a>
          {% else %}
            &nbsp;&nbsp;
          {% endif %}
        {% endfor %}
        </span>
        {% if C.can_add_tags %}
          &nbsp;<a rel="nofollow" id="addtag" onclick="$('#tagform').remove();sendRequest('action=xmlhttp;sa=tags;addtag=1;topic={{ C.current_topic }}', $('#addtag'));return(false);" data-id="{{ C.current_topic }}" href="{{ SCRIPTURL }}?action=tags;sa=addtag;topic={{ C.current_topic }}">{{ T.smftags_addtag }}</a>
        {% else %}
          &nbsp;
        {% endif %}
        </div>
      {% endif %} {# tags_active #}
      {{ C.num_replies }} Replies
      <div class="clear"></div>
      <div class="posts_container commentstyle" id="posts_container">
    {% endif %}
  {% endfor %}
 </div>
<input type="hidden" name="goadvanced" value="1" />
</form>
</div>
<a id="lastPost"></a>
{% if S.display_who_viewing %}
  <p id="whoisviewing" class="smalltext">
    {% if S.display_who_viewing == 1 %}
      {{ C.view_members|length }} {{ C.view_members|length == 1 ? T.who_member : T.members }}
    {% else %}
      {{ C.view_members_list is empty  ? '0 ' ~ T.members : implode(', ', C.view_members_list) ~ (C.view_num_hidden is empty or C.can_moderate_forum ? '' : ' (+ ' ~ C.view_num_hidden ~ ' ' ~ T.hidden ~ ')') }}
    {% endif %}
      {{ T.who_and }}{{ C.view_num_guests }} {{ C.view_num_guests == 1 ? T.guest : T.guests }}{{ T.who_viewing_topic }}
  </p>
{% endif %}

{% if C.can_reply and O.display_quick_reply %}
  <a id="quickreply"></a>
  <div class="clear"></div>
  <div style="display:none;overflow:hidden;" id="quickreplybox">
    <div class="cat_bar">
      <strong>{{ T.post_reply }}</strong>&nbsp;&nbsp;<a href="{{ SCRIPTURL }}?action=helpadmin;help=quickreply_help" onclick="return reqWin(this.href);" class="help tinytext">{{ T.post_reply_help }}</a>
    </div>
    <div class="flat_container mediumpadding">
      <input type="hidden" name="_qr_board" value="{{ C.current_board }}" />
      <input type="hidden" name="topic" value="{{ C.current_topic }}" />
      <input type="hidden" name="subject" value="{{ C.response_prefix }}{{ C.subject }}" />
      <input type="hidden" name="icon" value="xx" />
      <input type="hidden" name="from_qr" value="1" />
      <input type="hidden" name="notify" value="{{ C.is_marked_notify or O.auto_notify ? '1' : '0' }}" />
      <input type="hidden" name="not_approved" value="{{ not C.can_reply_approved }}" />
      <input type="hidden" name="goback" value="{{ O.return_to_post == 0 ? '0' : '1' }}" />
      <input type="hidden" name="last_msg" value="{{ C.topic_last_message }}" />
      <input type="hidden" name="{{ C.session_var }}" value="{{ C.session_id }}" />
      <input type="hidden" name="seqnum" value="{{ C.form_sequence_number }}" />
      {# Guests just need more. #}
      {% if C.user.is_guest %}
        <strong>{{ T.name }}:</strong> <input type="text" name="guestname" value="{{ C.name }}" size="25" class="input_text" tabindex="{{ tabindex }}" />
        <strong>{{ T.email }}:</strong> <input type="text" name="email" value="{{ C.email }}" size="25" class="input_text" tabindex="{{ tabindex }}" />
        <br>
      {% endif %}
      {# Is visual verification enabled? #}
      {% if C.require_verification %}
        <strong>{{ T.verification }}:</strong>
        {% include "visual_verification.twig" %}  {# template_control_verification($context['visual_verification_id'], 'quick_reply') #}
        <br />
      {% endif %}
      {% if C.user.avatar.image is defined and C.user.avatar.image is not empty %}
        <div class="floatleft blue_container smallpadding avatar">
          {{ C.user.avatar.image }}
        </div>
      {% endif %}
      <div class="quickReplyContent" style="margin-left:150px;">
        {{ C.is_locked ? '<div class="red_container tinytext">' ~ T.quick_reply_warning ~ '</div>' : '' }}
        {{ C.oldTopicError ? '<div class="red_container tinytext">' ~ sprintf(T.error_old_topic, M.oldTopicDays) ~ '</div>' : '' }}
        {{ C.can_reply_approved ? '' : '<em>' ~ T.wait_for_approval ~ '</em>' }}
        {{ not C.can_reply_approved and C.require_verification ? '<br>' : '' }}
        <textarea id="quickReplyMessage" style="width:99%;" rows="18" name="message" tabindex="{{ tabindex }}"></textarea>
        {% if C.automerge %}
          <input type="checkbox" name="want_automerge" id="want_automerge" checked="checked" value="1" />{{ T.want_automerge }}
        {% endif %}
      </div>
      <div class="righttext padding">
        <input type="submit" name="post" value="{{ T.post }}" onclick="return submitThisOnce(this);" accesskey="s" tabindex="{{ tabindex }}" class="button_submit" />
        <input type="submit" name="preview" value="{{ T.go_advanced }}" onclick="return submitThisOnce(this);" accesskey="p" tabindex="{{ tabindex }}" class="button_submit" />
        <input type="submit" name="cancel" value="Cancel" onclick="return(oQuickReply.cancel());" accesskey="p" tabindex="{{ tabindex }}" class="button_submit" />
      </div>
    </div>
    <br>
  </div>
{% endif %} {# quick reply #}
<div class="pagesection bottom">
  {{ button_strip(C.normal_buttons, 'right') }}
  {% if C.multiquote_posts_count > 0 %}
    <div class="floatright clear_right tinytext mediummargin mq_remove_msg">{{ sprintf(T.posts_marked_mq, C.multiquote_posts_count) }}&nbsp;<a href="#" onclick="return oQuickReply.clearAllMultiquote({{ C.current_topic }});">{{ T.remove }}</a></div>
  {% endif %}      
  <div class="pagelinks floatleft">{{ C.page_index }} {{ M.topbottomEnable ? C.menu_separator ~ ' &nbsp;&nbsp;<a href="#top"><strong>' ~ T.go_up ~ '</strong></a>' : '' }}</div>
  <div class="nextlinks_bottom">{{ C.previous_next }}</div>
</div>
{% include "linktree.twig" %}
<div id="moderationbuttons">
  {{ button_strip(C.mod_buttons, 'bottom', C.mod_buttons_style) }}
</div>
<div class="plainbox" id="display_jump_to">&nbsp;</div>
{% endblock content %}  
{% block footerscripts %}
{% set tabindex = 0 %}
<script>
// <![CDATA
  var smf_likelabel = '{{ T.like_label }}';
  var smf_unlikelabel = '{{ T.unlike_label }}';

  var oQuickReply = new QuickReply({
    bDefaultCollapsed: false,
    iTopicId: {{ C.current_topic }},
    iStart: {{ C.start }},
    sScriptUrl: smf_scripturl,
    sImagesUrl: "{{ S.images_url }}",
    sContainerId: "quickReplyOptions",
    sImageId: "quickReplyExpand",
    sImageCollapsed: "collapse.gif",
    sImageExpanded: "expand.gif",
    iMarkedForMQ: {{ C.multiquote_posts_count }},
    sJumpAnchor: "quickreplybox",
    bEnabled: {{ O.display_quick_reply ? 'true' : 'false' }}
  });

  {% if O.display_quick_mod and C.can_remove_post %}
    var oInTopicModeration = new InTopicModeration({
      sSelf: 'oInTopicModeration',
      sCheckboxContainerMask: 'in_topic_mod_check_',
      aMessageIds: ["{{ implode('", "', C.removableMessageIDs) }}"],
      sSessionId: '{{ C.session_id }}',
      sSessionVar: '{{ C.session_var }}',
      sButtonStrip: 'moderationbuttons',
      sButtonStripDisplay: 'moderationbuttons_strip',
      bUseImageButton: false,
      bCanRemove: {{ C.can_remove_post ? 'true' : 'false' }},
      sRemoveButtonLabel: '{{ T.quickmod_delete_selected }}',
      sRemoveButtonImage: 'delete_selected.gif',
      sRemoveButtonConfirm: '{{ T.quickmod_confirm }}',
      bCanRestore: {{ C.can_restore_msg ? 'true' : 'false' }},
      sRestoreButtonLabel: '{{ T.quick_mod_restore }}',
      sRestoreButtonImage: 'restore_selected.gif',
      sRestoreButtonConfirm: '{{ T.quickmod_confirm }}',
      sFormId: 'quickModForm'
    });
  {% endif %}

  if ('XMLHttpRequest' in window)
  {
    var oQuickModify = new QuickModify({
      sScriptUrl: smf_scripturl,
      bShowModify: {{ S.show_modify ? 'true' : 'false' }},
      iTopicId: {{ C.current_topic }},
      sTemplateBodyEdit: {{ JavaScriptEscape('<div id="quick_edit_body_container">
        <div id="error_box" style="padding: 4px;" class="error"></div>
        <textarea class="editor" name="message" rows="20" style="' ~ (C.browser.is_ie8 ? 'width: 635px; max-width: 100%; min-width: 100%' : 'width: 100%') ~ '; margin-bottom: 10px;" tabindex="' ~ tabindex ~ '">%body%</textarea><br />
        <input type="hidden" name="' ~ C.session_var ~ '" value="' ~ C.session_id ~ '" />
        <input type="hidden" name="topic" value="' ~ C.current_topic ~ '" />
        <input type="hidden" name="msg" value="%msg_id%" />
        <input type="hidden" style="width: 50%;" name="subject" value="%subject%" size="50" maxlength="80" tabindex="' ~ tabindex ~ '" class="input_text" />
        <div class="righttext">
          <span class="button floatright" onclick="return oQuickModify.goAdvanced(\'' ~ C.session_id ~ '\', \'' ~ C.session_var ~ '\');" />' ~ T.go_advanced ~ '</a></span>
          <span class="button floatright" onclick="return oQuickModify.modifyCancel();" >' ~ T.modify_cancel ~ '</span>
          <span class="button floatright" onclick="return oQuickModify.modifySave(\'' ~ C.session_id ~ '\', \'' ~ C.session_var ~ '\');" accesskey="s">' ~ T.save ~ '</span>
        </div>
        </div>') }},
      sTemplateSubjectEdit: {{ JavaScriptEscape('<input type="text" style="width: 50%;" name="subject_edit" value="%subject%" size="50" maxlength="80" tabindex="' ~ tabindex ~ '" class="input_text" />') }},
      sTemplateBodyNormal: {{ JavaScriptEscape('%body%') }},
      sTemplateSubjectNormal: {{ JavaScriptEscape('<a href="' ~ SCRIPTURL ~ '?topic=' ~ C.current_topic ~ '.msg%msg_id%#msg%msg_id%" rel="nofollow">%subject%</a>') }},
      sTemplateTopSubject: {{ JavaScriptEscape(T.topic ~ ': %subject% &nbsp;(' ~ T.read ~ ' ' ~ C.num_views ~ ' ' ~ T.times ~ ')') }},
      sErrorBorderStyle: {{ JavaScriptEscape('1px solid red') }}
    });

    aJumpTo[aJumpTo.length] = new JumpTo({
      sContainerId: "display_jump_to",
      sJumpToTemplate: '<label class="smalltext" for="%select_id%">{{ C.jump_to.label }}:</label> %dropdown_list%',
      iCurBoardId: {{ C.current_board }},
      iCurBoardChildLevel: {{ C.jump_to.child_level }},
      sCurBoardName: "{{ C.jump_to.board_name }}",
      sBoardChildLevelIndicator: "==",
      sBoardPrefix: "=> ",
      sCatSeparator: "-----------------------------",
      sCatPrefix: "",
      sGoButtonLabel: "{{ T.go }}"
    });
  }

  function getIntralink(e, mid) {
    var tid = {{ C.current_topic }};
    var _sid = "#subject_" + mid;
    var el = $("#interpostlink_helper");
    el.css("position", "fixed");
    var _content = "[ilink topic=" + tid + " post=" + mid + "]" + $(_sid).html().trim() + "[/ilink]";
    $("#interpostlink_helper_content").val(_content);
    $("#interpostlink_helper_content_full").val(e.attr("href"));
    centerElement(el, -200);
    el.css("z-index", 9999);
    setDimmed(1);
    el.show();
    $("#interpostlink_helper_content").focus();
    $("#interpostlink_helper_content").select();
  }
  $(document).keydown(function(e) {
    if(e.keyCode == 27 && $("#interpostlink_helper").css("display") != "none") {
      $("#interpostlink_helper").css("position", "static");
      $("#interpostlink_helper").hide();
      setDimmed(0);
    }
  });
  var topic_id = {{ C.current_topic }};
// ]]>
</script>
{% endblock footerscripts %}